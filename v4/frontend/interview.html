<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Interview Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #5CCBEE;
            --color-secondary: #6EE7B7;
            --color-accent: #FFB4A2;
            --color-purple: #A78BFA;
            --color-yellow: #FFD166;
            --font-body: 'Nunito Sans', sans-serif;
            --font-headline: 'Comfortaa', cursive;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-purple) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page { display: none; width: 100%; height: 100vh; }
        .page.active { display: flex; flex-direction: column; }

        .container {
            max-width: 800px;
            padding: 60px 50px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            margin: auto;
        }

        h1 {
            font-family: var(--font-headline);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }

        p { font-size: 1.2em; color: #666; margin-bottom: 40px; line-height: 1.6; }

        .btn {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-purple) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
            font-weight: 700;
            font-family: var(--font-body);
            box-shadow: 0 4px 15px rgba(92, 203, 238, 0.4);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(92, 203, 238, 0.6); }

        .countdown {
            font-size: 6rem;
            color: var(--color-primary);
            font-weight: bold;
            font-family: var(--font-headline);
            margin: 2rem 0;
            animation: countPulse 1s infinite;
        }

        @keyframes countPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .interview-container {
            width: 100%;
            height: 100vh;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            background: #16213e;
        }

        .video-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background: #0f3460;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-wrapper video { width: 100%; height: 100%; object-fit: cover; }

        .ai-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-purple) 100%);
        }

        video.ai-avatar {
            object-fit: cover;
            background: #1a1a2e;
        }

        .avatar-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 5px solid rgba(255, 255, 255, 0.4);
            animation: float 3s ease-in-out infinite;
        }

        .avatar-icon { font-size: 100px; }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }

        .speaking .avatar-circle {
            animation: float 3s ease-in-out infinite, pulse-speaking 0.5s ease-in-out infinite;
            border-color: rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse-speaking { 0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); } 50% { box-shadow: 0 0 40px rgba(255,255,255,0.6); } }

        .video-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10;
        }

        .caption-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
            line-height: 1.6;
            display: none;
            max-height: 40%;
            overflow-y: auto;
        }

        .caption-overlay.active { display: block; }
        .caption-text { text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }

        .controls-bar {
            background: #0f3460;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: var(--font-body);
        }

        .control-btn:hover { background: rgba(92, 203, 238, 0.3); border-color: var(--color-primary); }
        .control-btn.active { background: var(--color-secondary); border-color: var(--color-secondary); color: #333; }
        .control-btn.end { background: #e74c3c; border-color: #e74c3c; }
        .control-btn.end:hover { background: #c0392b; }

        .status-indicator { display: flex; align-items: center; gap: 0.5rem; color: white; font-weight: 600; }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-secondary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .timer-display {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            display: none;
        }

        .timer-display.visible { display: block; }
        .timer-display.warning { background: rgba(255, 209, 102, 0.3); border-color: var(--color-yellow); animation: pulse-warning 1s infinite; }
        .timer-display.critical { background: rgba(255, 180, 162, 0.3); border-color: var(--color-accent); animation: pulse-critical 0.5s infinite; }

        @keyframes pulse-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-critical { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .summary-container {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-purple) 100%);
            padding: 2rem;
        }

        .summary-content {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .summary-header { text-align: center; margin-bottom: 3rem; }
        .overall-score { font-size: 4rem; font-weight: bold; font-family: var(--font-headline); color: var(--color-primary); margin: 1rem 0; }
        .score-label { font-size: 1.2rem; color: #666; font-weight: 600; }

        .score-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 5px solid var(--color-primary);
        }

        .score-section h2 {
            font-family: var(--font-headline);
            color: var(--color-primary);
            font-size: 1.8rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-score { font-size: 2rem; font-weight: bold; font-family: var(--font-headline); color: var(--color-secondary); }
        .feedback-text { color: #555; line-height: 1.8; margin-bottom: 1.5rem; font-size: 1.1rem; }
        .list-section { margin-top: 1rem; }
        .list-section h3 { font-weight: 700; color: var(--color-purple); font-size: 1.2rem; margin-bottom: 0.5rem; }
        .list-section ul { list-style-position: inside; color: #555; line-height: 1.8; }
        .strengths li { color: #27ae60; }
        .improvements li { color: #e67e22; }

        .key-takeaways {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-purple) 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .key-takeaways h2 { font-family: var(--font-headline); font-size: 1.8rem; margin-bottom: 1rem; }
        .key-takeaways ul { list-style-position: inside; line-height: 2; font-size: 1.1rem; }

        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 3rem; }

        .loading { text-align: center; padding: 3rem; color: var(--color-primary); font-size: 1.5rem; font-weight: 600; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #ffd166;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-body);
            z-index: 1000;
        }

        .setup-info { background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 8px; color: white; font-size: 0.9rem; }

        @media (max-width: 768px) {
            .video-container { grid-template-columns: 1fr; }
            .controls-bar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">‚Üê Back</button>

    <div id="mainPage" class="page active">
        <div class="container">
            <h1>üéôÔ∏è Real-Time Interview Simulation</h1>
            <div id="setupSummary"></div>
            <p>Experience a realistic job interview with AI-powered feedback.</p>
            <button class="btn" onclick="startPreparation()">Start Interview</button>
        </div>
    </div>

    <div id="preparationPage" class="page">
        <div class="container">
            <h1>üé¨ Preparing Your Interview</h1>
            <p>Setting up your camera and microphone...</p>
            <div class="countdown" id="countdown">5</div>
            <p>Get ready!</p>
        </div>
    </div>

    <div id="interviewPage" class="page">
        <div class="interview-container">
            <div class="video-container">
                <div class="video-wrapper">
                    <div class="video-label">ü§ñ AI Interviewer</div>
                    <video id="aiVideo" class="ai-avatar" autoplay playsinline style="display: none;"></video>
                    <div id="aiAvatar" class="ai-avatar">
                        <div class="avatar-circle"><div class="avatar-icon">ü§ñ</div></div>
                    </div>
                    <div id="captionOverlay" class="caption-overlay">
                        <div id="captionText" class="caption-text"></div>
                    </div>
                </div>
                <div class="video-wrapper">
                    <div class="video-label">üë§ You</div>
                    <video id="userVideo" autoplay muted playsinline></video>
                </div>
            </div>
            <div class="controls-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="statusText">Interview in Progress</span>
                </div>
                <div id="timerDisplay" class="timer-display">‚è±Ô∏è <span id="timerText">30</span>s</div>
                <div class="setup-info" id="interviewInfo"></div>
                <button id="captionBtn" class="control-btn" onclick="toggleCaptions()">üìù Captions</button>
                <button id="muteBtn" class="control-btn" onclick="toggleMute()">üé§ Mute</button>
                <button class="control-btn end" onclick="endInterview()">‚èπÔ∏è End</button>
            </div>
        </div>
    </div>

    <div id="summaryPage" class="page">
        <div class="summary-container">
            <div id="summaryLoading" class="loading">
                <h2>Analyzing Your Interview...</h2>
                <div class="spinner"></div>
                <p>Please wait while we prepare your personalized feedback</p>
            </div>
            <div id="summaryContent" class="summary-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        let peerConnection = null;
        let dataChannel = null;
        let localStream = null;
        let audioContext = null;
        let audioAnalyzer = null;
        let isInterviewActive = false;
        let isMuted = false;
        let captionsEnabled = false;
        let currentAIMessage = '';
        let recordingTimer = null;
        let recordingTimeLeft = 30;
        let isAiSpeaking = false;
        let interviewSetup = null;
        let pingInterval = null;
        
        // Store all transcript entries for summary analysis
        let transcriptHistory = [];
        let interviewStartTime = null;
        let questionCount = 0;

        const BOT_URL = 'http://localhost:7860';

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        window.addEventListener('DOMContentLoaded', () => {
            const setupData = localStorage.getItem('interviewSetup');
            if (setupData) {
                try {
                    interviewSetup = JSON.parse(setupData);
                    document.getElementById('setupSummary').innerHTML = `
                        <div style="background:#f0f9ff;padding:1rem;border-radius:10px;margin-bottom:1rem;text-align:left;">
                            <strong>üìã Interview Setup:</strong><br>
                            Position: ${interviewSetup.jobTitle || 'Not specified'}<br>
                            Company: ${interviewSetup.company || 'Not specified'}<br>
                            Format: ${interviewSetup.interviewFormat || 'Not specified'}
                        </div>`;
                } catch (e) { console.error('Error loading setup:', e); }
            }
        });

        async function startPreparation() {
            showPage('preparationPage');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                let countdown = 5;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    if (countdown <= 0) { clearInterval(timer); startInterview(); }
                }, 1000);
            } catch (error) {
                alert('Please allow camera and microphone access.');
                showPage('mainPage');
            }
        }

        async function startInterview() {
            showPage('interviewPage');
            isInterviewActive = true;
            interviewStartTime = Date.now();
            transcriptHistory = [];
            questionCount = 0;
            document.getElementById('userVideo').srcObject = localStream;
            if (interviewSetup) {
                document.getElementById('interviewInfo').textContent = 
                    `${interviewSetup.jobTitle || 'Interview'} @ ${interviewSetup.company || 'Company'}`;
            }

            try {
                if (interviewSetup) {
                    try {
                        await fetch(`${BOT_URL}/api/setup`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(interviewSetup)
                        });
                    } catch (e) { console.log('Setup endpoint not available'); }
                }

                peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                let pcId = null;
                let pendingCandidates = [];

                peerConnection.ontrack = (event) => {
                    if (event.track.kind === 'audio') {
                        let audioEl = document.getElementById('aiAudio');
                        if (!audioEl) {
                            audioEl = document.createElement('audio');
                            audioEl.id = 'aiAudio';
                            audioEl.autoplay = true;
                            document.body.appendChild(audioEl);
                        }
                        audioEl.srcObject = new MediaStream([event.track]);
                        setupAudioMonitoring(event.track);
                    } else if (event.track.kind === 'video') {
                        // Handle video track from Simli AI avatar
                        console.log('üé• Received video track from Simli avatar');
                        const aiVideo = document.getElementById('aiVideo');
                        const aiAvatar = document.getElementById('aiAvatar');
                        
                        if (aiVideo) {
                            aiVideo.srcObject = new MediaStream([event.track]);
                            aiVideo.style.display = 'block';
                            aiVideo.style.objectFit = 'cover';
                            aiVideo.style.width = '100%';
                            aiVideo.style.height = '100%';
                            
                            // Hide the static avatar placeholder when video is playing
                            if (aiAvatar) {
                                aiAvatar.style.display = 'none';
                            }
                            
                            aiVideo.onloadedmetadata = () => {
                                console.log('üé• AI video metadata loaded, starting playback');
                                aiVideo.play().catch(e => console.log('Video autoplay issue:', e));
                            };
                        }
                    }
                };

                peerConnection.onicecandidate = async (event) => {
                    if (!event.candidate) return;
                    const candidate = {
                        candidate: event.candidate.candidate,
                        sdp_mid: event.candidate.sdpMid,
                        sdp_mline_index: event.candidate.sdpMLineIndex
                    };
                    if (!pcId) { pendingCandidates.push(candidate); return; }
                    await fetch(`${BOT_URL}/api/offer`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pc_id: pcId, candidates: [candidate] })
                    });
                };

                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'connected') updateStatus('‚úÖ Connected');
                    else if (peerConnection.connectionState === 'failed') updateStatus('‚ùå Connection lost');
                };

                // Handle data channel from server (for receiving transcripts)
                peerConnection.ondatachannel = (event) => {
                    const serverChannel = event.channel;
                    console.log('Received data channel from server:', serverChannel.label);
                    
                    serverChannel.onmessage = (msgEvent) => {
                        console.log('Received message from server:', msgEvent.data);
                        try {
                            const msg = JSON.parse(msgEvent.data);
                            if (msg.type === 'bot-transcription' && msg.data) {
                                currentAIMessage = msg.data;
                                addTranscriptEntry('ai', msg.data);
                                if (captionsEnabled) {
                                    const captionText = document.getElementById('captionText');
                                    captionText.textContent = msg.data;
                                }
                            }
                        } catch (e) {
                            // Ignore non-JSON messages
                            console.log('Non-JSON message:', msgEvent.data);
                        }
                    };
                };

                dataChannel = peerConnection.createDataChannel('chat');
                dataChannel.onopen = () => {
                    pingInterval = setInterval(() => {
                        if (dataChannel?.readyState === 'open') dataChannel.send('ping');
                    }, 1000);
                };
                
                // Handle incoming messages from bot (transcripts) - for client-created channel
                dataChannel.onmessage = (event) => {
                    console.log('Received on client channel:', event.data);
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'bot-transcription' && msg.data) {
                            currentAIMessage = msg.data;
                            addTranscriptEntry('ai', msg.data);
                            if (captionsEnabled) {
                                const captionText = document.getElementById('captionText');
                                captionText.textContent = msg.data;
                            }
                        }
                    } catch (e) {
                        // Ignore non-JSON messages (pong, etc.)
                    }
                };

                const audioTransceiver = peerConnection.addTransceiver('audio', { direction: 'sendrecv' });
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) audioTransceiver.sender.replaceTrack(audioTrack);
                peerConnection.addTransceiver('video', { direction: 'recvonly' });

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const response = await fetch(`${BOT_URL}/api/offer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sdp: offer.sdp, type: offer.type, pc_id: null, request_data: interviewSetup || {} })
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const answer = await response.json();
                pcId = answer.pc_id;
                await peerConnection.setRemoteDescription({ sdp: answer.sdp, type: answer.type });

                if (pendingCandidates.length > 0) {
                    await fetch(`${BOT_URL}/api/offer`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pc_id: pcId, candidates: pendingCandidates })
                    });
                }
                updateStatus('üé§ AI is greeting you...');
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect. Make sure bot is running:\ncd f:\\_CNL\\v4\\pipecat-quickstart\nuv run bot.py');
            }
        }

        function setupAudioMonitoring(audioTrack) {
            try {
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(new MediaStream([audioTrack]));
                audioAnalyzer = audioContext.createAnalyser();
                audioAnalyzer.fftSize = 256;
                source.connect(audioAnalyzer);

                const dataArray = new Uint8Array(audioAnalyzer.frequencyBinCount);
                let silenceTimer = null;

                function checkAudioLevel() {
                    if (!audioAnalyzer || !isInterviewActive) return;
                    audioAnalyzer.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

                    if (average > 10) {
                        if (!isAiSpeaking) { isAiSpeaking = true; onAiStartedSpeaking(); }
                        if (silenceTimer) { clearTimeout(silenceTimer); silenceTimer = null; }
                    } else if (isAiSpeaking) {
                        if (!silenceTimer) {
                            silenceTimer = setTimeout(() => { isAiSpeaking = false; onAiStoppedSpeaking(); }, 1000);
                        }
                    }
                    requestAnimationFrame(checkAudioLevel);
                }
                checkAudioLevel();
            } catch (e) { console.error('Audio monitoring error:', e); }
        }

        function onAiStartedSpeaking() {
            document.getElementById('aiAvatar')?.classList.add('speaking');
            updateStatus('üé§ AI is speaking...');
            stopTimer();
        }

        function onAiStoppedSpeaking() {
            document.getElementById('aiAvatar')?.classList.remove('speaking');
            if (isInterviewActive) {
                updateStatus('‚úÖ Your turn - 30 seconds!');
                startAnswerTimer();
            }
        }

        function startAnswerTimer() {
            stopTimer();
            if (!isInterviewActive) return;
            recordingTimeLeft = 30;
            const timerDisplay = document.getElementById('timerDisplay');
            const timerText = document.getElementById('timerText');
            timerDisplay.classList.add('visible');
            timerDisplay.classList.remove('warning', 'critical');
            timerText.textContent = recordingTimeLeft;

            recordingTimer = setInterval(() => {
                if (!isInterviewActive) { stopTimer(); return; }
                recordingTimeLeft--;
                timerText.textContent = recordingTimeLeft;
                if (recordingTimeLeft <= 5) { timerDisplay.classList.add('critical'); timerDisplay.classList.remove('warning'); }
                else if (recordingTimeLeft <= 10) { timerDisplay.classList.add('warning'); timerDisplay.classList.remove('critical'); }
                if (recordingTimeLeft <= 0) stopTimer();
            }, 1000);
        }

        function stopTimer() {
            if (recordingTimer) { clearInterval(recordingTimer); recordingTimer = null; }
            document.getElementById('timerDisplay').classList.remove('visible', 'warning', 'critical');
        }

        function updateStatus(message) { document.getElementById('statusText').textContent = message; }
        
        // Store transcript entries for analysis
        function addTranscriptEntry(speaker, text) {
            transcriptHistory.push({
                speaker: speaker,
                text: text,
                timestamp: Date.now()
            });
            // Count AI questions (messages ending with ?)
            if (speaker === 'ai' && text.includes('?')) {
                questionCount++;
            }
        }

        function toggleCaptions() {
            captionsEnabled = !captionsEnabled;
            const overlay = document.getElementById('captionOverlay');
            const btn = document.getElementById('captionBtn');
            overlay.classList.toggle('active', captionsEnabled);
            btn.classList.toggle('active', captionsEnabled);
            btn.textContent = captionsEnabled ? 'üìù Hide' : 'üìù Captions';
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            localStream?.getAudioTracks().forEach(track => { track.enabled = !isMuted; });
            btn.textContent = isMuted ? 'üîá Unmute' : 'üé§ Mute';
            btn.classList.toggle('active', isMuted);
        }

        function endInterview() {
            if (!confirm('End the interview?')) return;
            endInterviewAndShowSummary();
        }

        function endInterviewAndShowSummary() {
            isInterviewActive = false;
            stopTimer();
            if (pingInterval) { clearInterval(pingInterval); pingInterval = null; }
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            if (dataChannel) { dataChannel.close(); dataChannel = null; }
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            const aiAudio = document.getElementById('aiAudio');
            if (aiAudio) { aiAudio.srcObject = null; aiAudio.remove(); }
            if (audioContext) { audioContext.close(); audioContext = null; audioAnalyzer = null; }
            showPage('summaryPage');
            generateSummary();
        }

        async function generateSummary() {
            await new Promise(r => setTimeout(r, 2000));
            document.getElementById('summaryLoading').style.display = 'none';
            const contentEl = document.getElementById('summaryContent');
            contentEl.style.display = 'block';

            // Calculate interview duration
            const duration = interviewStartTime ? Math.floor((Date.now() - interviewStartTime) / 1000) : 0;
            const durationMinutes = Math.floor(duration / 60);
            const durationSeconds = duration % 60;
            
            // Analyze transcript history
            const aiMessages = transcriptHistory.filter(t => t.speaker === 'ai');
            const userMessages = transcriptHistory.filter(t => t.speaker === 'user');
            
            // Calculate metrics based on actual interview
            const totalQuestions = questionCount || aiMessages.filter(m => m.text.includes('?')).length;
            const hasTranscripts = transcriptHistory.length > 0;
            
            // Generate realistic scores based on interview participation
            // Base score is lower, adjusted by participation metrics
            let baseScore = 55;
            let languageScore = 50;
            let answerScore = 50;
            
            if (hasTranscripts) {
                // More questions answered = better scores
                baseScore = Math.min(85, 55 + (totalQuestions * 5));
                languageScore = Math.min(80, 48 + (totalQuestions * 4) + (durationMinutes * 2));
                answerScore = Math.min(82, 50 + (totalQuestions * 5) + (durationMinutes * 1));
            }
            
            // Generate detailed feedback based on interview content
            const jobTitle = interviewSetup?.jobTitle || 'the position';
            const company = interviewSetup?.company || 'the company';
            
            // Extract sample questions from AI messages for feedback
            const sampleQuestions = aiMessages
                .filter(m => m.text.includes('?'))
                .slice(0, 3)
                .map(m => m.text.split('?')[0] + '?');
            
            const summary = {
                overall_score: baseScore,
                duration: `${durationMinutes}m ${durationSeconds}s`,
                questions_asked: totalQuestions,
                language_use: {
                    score: languageScore,
                    feedback: hasTranscripts 
                        ? `You participated in a ${durationMinutes}-minute interview session. Your responses were delivered naturally with ${totalQuestions} exchange${totalQuestions > 1 ? 's' : ''} with the interviewer.`
                        : "Unable to analyze speech patterns. Consider enabling captions to review your responses.",
                    strengths: [
                        "Completed the interview session",
                        totalQuestions > 2 ? "Engaged with multiple questions" : "Started the interview process",
                        durationMinutes > 2 ? "Maintained conversation for extended period" : "Practiced quick responses"
                    ],
                    improvements: [
                        "Practice speaking more slowly and clearly",
                        "Use more specific examples when answering",
                        "Vary your sentence structure to avoid repetition",
                        "Reduce filler words (um, uh, like)"
                    ]
                },
                answer_quality: {
                    score: answerScore,
                    feedback: `During your mock interview for ${jobTitle}, you addressed ${totalQuestions} question${totalQuestions !== 1 ? 's' : ''}. ${totalQuestions > 3 ? 'You demonstrated good engagement by responding to multiple topics.' : 'Consider practicing more to cover a broader range of interview topics.'}`,
                    strengths: [
                        "Completed a realistic interview simulation",
                        totalQuestions > 2 ? "Addressed multiple interview scenarios" : "Got started with interview practice",
                        "Practiced under real-time conditions"
                    ],
                    improvements: [
                        "Quantify your achievements with specific numbers",
                        "Prepare 3-5 versatile stories from your experience",
                        `Research ${company}'s recent news and initiatives`,
                        "Structure answers with clear beginning, middle, and end"
                    ]
                },
                detailed_feedback: `
                    <p><strong>Interview Summary:</strong> You completed a ${durationMinutes}-minute mock interview for the ${jobTitle} role at ${company}. The AI interviewer asked ${totalQuestions} question${totalQuestions !== 1 ? 's' : ''} during this session.</p>
                    
                    <p><strong>What Went Well:</strong> You successfully connected to the interview and engaged with the AI interviewer. ${totalQuestions > 3 ? 'You showed stamina by answering multiple questions.' : 'This is a great start to your interview practice.'}</p>
                    
                    <p><strong>Areas for Growth:</strong> To improve your scores, focus on providing specific examples from your experience. Use the STAR method (Situation, Task, Action, Result) to structure behavioral answers. Practice articulating your achievements with measurable outcomes.</p>
                    
                    <p><strong>Recommended Next Steps:</strong></p>
                    <ul>
                        <li>Practice with 2-3 more mock interviews</li>
                        <li>Prepare stories for common behavioral questions</li>
                        <li>Record yourself to review body language</li>
                        <li>Research ${company}'s values and culture</li>
                    </ul>
                `,
                questions_covered: sampleQuestions.length > 0 ? sampleQuestions : ["Interview questions were covered during the session"],
                key_takeaways: [
                    "Quantify achievements with specific metrics",
                    "Prepare versatile stories that showcase different skills",
                    `Research ${company} before your real interview`,
                    "Practice answering within 2-minute time limits",
                    "Follow up with a thank-you note after your interview"
                ]
            };

            contentEl.innerHTML = `
                <div class="summary-header">
                    <h1>üìä Interview Feedback</h1>
                    <div class="interview-stats" style="display:flex;gap:2rem;justify-content:center;margin:1rem 0;color:#666;">
                        <span>‚è±Ô∏è Duration: ${summary.duration}</span>
                        <span>‚ùì Questions: ${summary.questions_asked}</span>
                    </div>
                    <div class="score-label">Overall Score</div>
                    <div class="overall-score">${summary.overall_score}/100</div>
                </div>
                <div class="score-section">
                    <h2><span>üó£Ô∏è Language Use</span><span class="section-score">${summary.language_use.score}/100</span></h2>
                    <p class="feedback-text">${summary.language_use.feedback}</p>
                    <div class="list-section strengths"><h3>‚úÖ Strengths:</h3><ul>${summary.language_use.strengths.map(s => `<li>${s}</li>`).join('')}</ul></div>
                    <div class="list-section improvements"><h3>üí° Improvements:</h3><ul>${summary.language_use.improvements.map(i => `<li>${i}</li>`).join('')}</ul></div>
                </div>
                <div class="score-section">
                    <h2><span>üíº Answer Quality</span><span class="section-score">${summary.answer_quality.score}/100</span></h2>
                    <p class="feedback-text">${summary.answer_quality.feedback}</p>
                    <div class="list-section strengths"><h3>‚úÖ Strengths:</h3><ul>${summary.answer_quality.strengths.map(s => `<li>${s}</li>`).join('')}</ul></div>
                    <div class="list-section improvements"><h3>üí° Improvements:</h3><ul>${summary.answer_quality.improvements.map(i => `<li>${i}</li>`).join('')}</ul></div>
                </div>
                <div class="score-section"><h2>üìù Detailed Feedback</h2><div class="feedback-text">${summary.detailed_feedback}</div></div>
                <div class="key-takeaways"><h2>üéØ Key Takeaways</h2><ul>${summary.key_takeaways.map(t => `<li>${t}</li>`).join('')}</ul></div>
                <div class="action-buttons">
                    <button class="btn" onclick="location.href='index.html'">Home</button>
                    <button class="btn" onclick="location.reload()">New Interview</button>
                </div>`;
        }

        function goBack() {
            if (isInterviewActive) { if (!confirm('End interview?')) return; endInterviewAndShowSummary(); }
            else window.location.href = 'index.html';
        }

        window.addEventListener('beforeunload', () => {
            isInterviewActive = false;
            stopTimer();
            if (pingInterval) clearInterval(pingInterval);
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (audioContext) audioContext.close();
        });
    </script>
</body>
</html>
